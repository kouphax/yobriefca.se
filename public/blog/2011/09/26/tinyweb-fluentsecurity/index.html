
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tinyweb Fluent Security - Yo Briefcase!</title>
  <meta name="author" content="James Hughes">

  <link href='http://fonts.googleapis.com/css?family=Port+Lligat+Slab' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Fresca' rel='stylesheet' type='text/css'>

  
  <meta name="description" content="I&#8217;ve been working on a little project recently that is using Tinyweb. It&#8217;s a typical little CRUDdy app and makes use of typical security &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yobriefca.se/blog/2011/09/26/tinyweb-fluentsecurity">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/feed" rel="alternate" title="Yo Briefcase!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-19143623-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div id="thingyattop" style="height:1px; background-color: #AAA; border-bottom: 1px solid #E0E0E0"></div>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
   
  <header>
    
      <h1 class="entry-title">Tinyweb Fluent Security</h1>
    

    
      <p class="meta">
        
          <span class="label" style="margin-right:10px;"><a href="/" style="text-decoration:none; text-transform:none; color:#fff">&larr;</a></span>
         
        








  


<time datetime="2011-09-26T00:00:00+01:00" pubdate data-updated="true">Sep 26<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&#8217;ve been working on a little project recently that is using Tinyweb.  It&#8217;s a typical little CRUDdy app and makes use of typical security features in a web app.  Tinyweb itself doesn&#8217;t provide any sort of custom security features out of the box but as it sits on top of ASP.NET you can avail of all the normal membership stuff.  Problem is though - the default membership stuff, when working directly with it, is a bit cumbersome.  I recently tinkered with a project for ASP.NET MVC called <a href="http://www.fluentsecurity.net/">FluentSecurity</a> that added a fluent syntax to configuring security for ASP.NET MVC applications.  Taking a healthy dose of inspiration from this project I rolled a lightweight Tinyweb version of my own.  I figure this might be useful to someone else so I have now created a new project specifically for this.  It&#8217;s probably totally broken in areas but the areas I&#8217;ve written tests around appear to work.</p>

<p>The source is available in a <a href="https://bitbucket.org/kouphax/tinyweb-fluentsecurity">BitBucket repository</a> so feel free to critique.  Once I get it tested better, documents written up and generally applied a bit of sipt and polish I&#8217;ll push it to Nuget and the fun can really begin.</p>

<h1>Tinyweb.FluentSecurity</h1>

<p>FluentSecurity comes as a 2 part solution</p>

<ol>
<li>The <code>Security</code> class is the main entry point for configuring FluentSecurity and authenticating users</li>
<li>The <code>SecurityFilter</code> class is a Tinyweb filter that performs auth tests on the current request</li>
</ol>


<h2>Security</h2>

<p>The <code>Security</code> class provides a central location to configure FluentSecurity.  <code>Security</code> is also responsible for executing the auth tests you pass to it.</p>

<h3>Security.Configure(Action<Configurator> configurator)</h3>

<p><code>Configure</code> lets you define the configuration for you module.  It accepts an Action that can be used to define rules for each handler.  For example</p>

<pre><code>Security.Configure(c =&gt;
{
    c.For&lt;RootHandler&gt;().DenyAnonymousAccess();
    c.For&lt;AdminHandler&gt;().RequireRoles("Admin");
    c.For&lt;UserHandler&gt;().DenyRoles("Admin");
    c.For&lt;SecretHandler&gt;().AllowVerbs(Security.AllowedVerbs.GET | Security.AllowedVerbs.POST);
});

Tinyweb.Init();
</code></pre>

<p>We call <code>Security.Configure</code> just before we Init Tinyweb (though it can be done at anytime realistically speaking).  The configuration block shows off most of the ways you can configure handlers e.g.</p>

<ol>
<li><code>DenyAnonymousAccess</code> will prevent, as the name suggests, all anonymous users from accessing this handler</li>
<li><code>RequireRoles</code> specifes 1..N roles that are required to access this handler</li>
<li><code>DenyRoles</code> specifies 1..N roles that aren&#8217;t permitted to access this handler</li>
<li><code>AllowVerbs</code> restricts the HTTP Verbs that can be used to access this handler (PUT, POST, GET etc.)</li>
<li><code>WithCustomRule</code> (not listed) allows you to specify a function that can be used to apply a custom rule to each request</li>
</ol>


<p>Each method returns the configuration object so it is possible to chain the calls to create more complex rules.</p>

<pre><code>Security.Configure(c =&gt;
    c.For&lt;EditHandler&gt;()
        .DenyAnonymousAccess()
        .RequireRoles("Author")
        .DenyRoles("Reader")
        .AllowVerbs(Security.AllowedVerbs.POST);
</code></pre>

<p>Obviously some combinations will not make sense, in fact AllowedVerbs needs to be tweaked as it may only apply to certain roles (so the combinations don&#8217;t make sense right now).  Currently FluentSecurity doesn&#8217;t care and it probably never will if you try and create illogical combinations.</p>

<h3>bool Security.Test(RequestContext req, HandlerData d)</h3>

<p>This will run all pre-configured rules against the current request to determine if the request is authorised to continue.  It will return a true/false result depengin on whether the rules pass or not.</p>

<pre><code>bool granted = Security.Test(context, data);
</code></pre>

<h3>IResult Security.Validate(RequestContext req, HandlerData d)</h3>

<p>Implements the typical SecurityFilter use case.  This function will call the <code>Test</code> method and returns <code>Result.None()</code> if the test passes (may be configurable in the future) otherwise it executes the <code>Security.OnAccessDenied</code> function and returns the <code>IResult</code>.  If no <code>OnAccessDenied</code> is defined <code>Result.None()</code> will be returned.</p>

<pre><code>IResult result = Security.Validate(context, data);
</code></pre>

<p>This is simply shorthand for now but may be expanded with some custom logic in the near future.</p>

<h3>Security.OnAccessDenied</h3>

<p>This property is used to define a function that can be used to return a result should access been denied.  This is done lazily as it allows you access to the <code>RequestContext</code> and <code>HandlerData</code> so you could implement per-request handling of the Result (redirects or return URLs etc.)</p>

<pre><code>Security.OnAccessDenied = (c, d) =&gt; Result.Redirect&lt;AccessDeniedHandler&gt;();
</code></pre>

<h2>SecurityFilter</h2>

<p>The <code>SecurityFilter</code> class is simply a Tinyweb filter that performs the request validation for authentication.  Nothing special here move along now.</p>

<h1>For Now and Up Next</h1>

<p>So thats all there is for now.  Code is, as I&#8217;ve said, available at the <a href="https://bitbucket.org/kouphax/tinyweb-fluentsecurity">BitBucket repository</a>.  I&#8217;m starting to build up some docs and stuff now and maybe tweak and add useful features.  If there is anything you would like to see raise it as an <a href="https://bitbucket.org/kouphax/tinyweb-fluentsecurity/issues?status=new&amp;status=open">issue</a> and I&#8217;ll get around to it.</p>
</div>


  <footer>
    <p class="meta">
      








  


<time datetime="2011-09-26T00:00:00+01:00" pubdate data-updated="true">Sep 26<span>th</span>, 2011</time>
      

<span style="float:right">
  
    <a href='/blog/categories/-net/' style='text-decoration:none;'><span class='label label-info'>.NET</span></a> <a href='/blog/categories/security/' style='text-decoration:none;'><span class='label label-info'>Security</span></a> <a href='/blog/categories/tinyweb/' style='text-decoration:none;'><span class='label label-info'>Tinyweb</span></a> <a href='/blog/categories/web/' style='text-decoration:none;'><span class='label label-info'>Web</span></a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://yobriefca.se/blog/2011/09/26/tinyweb-fluentsecurity/" data-via="kouphax" data-counturl="http://yobriefca.se/blog/2011/09/26/tinyweb-fluentsecurity/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/09/21/personal-systems-of-disorganisation/" title="Previous Post: Personal Systems of (Dis)Organisation">&laquo; Personal Systems of (Dis)Organisation</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/10/03/dddbelfast-retrospective/" title="next Post: DDDBelfast Retrospective">DDDBelfast Retrospective &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <script>var dis_inpost = true;</script>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'kouphax';
      
        
        if(window.dis_inpost){
          var disqus_identifier = 'http://yobriefca.se/blog/2011/09/26/tinyweb-fluentsecurity/';
          var disqus_url = 'http://yobriefca.se/blog/2011/09/26/tinyweb-fluentsecurity/';
          var disqus_script = 'embed.js';
        }else{
          var disqus_script = 'count.js';
        }

      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
