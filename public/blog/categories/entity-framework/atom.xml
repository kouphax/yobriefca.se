<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[<span class="label" style="margin-right:10px;"><a href="/" style="text-decoration:none; text-transform:none; color:#fff">&larr;</a></span>Entity Framework | Yo Briefcase!]]></title>
  <link href="http://yobriefca.se/blog/categories/entity-framework/atom.xml" rel="self"/>
  <link href="http://yobriefca.se/"/>
  <updated>2012-10-06T10:26:40+01:00</updated>
  <id>http://yobriefca.se/</id>
  <author>
    <name><![CDATA[James Hughes]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Entity Framework: Code First - Head First]]></title>
    <link href="http://yobriefca.se/blog/2011/02/11/entity-framework-code-first-head-first/"/>
    <updated>2011-02-11T00:00:00+00:00</updated>
    <id>http://yobriefca.se/blog/2011/02/11/entity-framework-code-first-head-first</id>
    <content type="html"><![CDATA[<p>  <p>I find the data access layer on most projects to be either overly complex or  fiddly with lots of XML mapping files that are difficult to debug so anything  that could make this layer more developer friendly I&rsquo;m all for it.&nbsp; Though I  also want to point out that I understand why the DAL is often complex &ndash; there is  a lot to consider and so I want to also understand if these &ldquo;friendlier&rdquo;  technologies can handle that sort of complexity or if they simply make the happy  path easier but making the more complex scenarios more difficult or even  impossible (which is obviously a blocker).</p><p>So I&rsquo;ve been tinkering with this new Entity Framework CTP5 release and the  &ldquo;Code First&rdquo; features recently.&nbsp; This comes after some time-out from EF due to  some really bad experiences with EF1. I was promised that there has been  significant changes/improvements since I last dabbled and it really seems there  have been.&nbsp; So I wanted to put it to the test and as one of my co-workers wanted  an &ldquo;Ideas&rdquo; app I thought it would be a fun [may not be anyone's definition of  fun but my own] to throw an MVC app together using EF &ldquo;Code First&rdquo; to model my  domain entities.&nbsp; To make it all even more simple I went ahead and used SQL  Server CE 4 for persistence.&nbsp; So what did the solution need to do?&nbsp; The basic  requirements were,</p><ol><li>Use Windows Authentication for users </li><li>Allow users to submit an idea (Title, Description) </li><li>Allow users to tag an idea with a variable number of tags </li><li>Allow users to vote up or vote down ideas (but not their own) </li><li>Allow users to comment on ideas </li><li>Allow users to filter ideas by tags </li><li>Allow users to sort ideas by newest ideas or by most popular. </li></ol><p>Nothing too extreme involved &ndash; not unless you turn the whole thing into a  computer game style EXTREME speed run competition &ndash; man vs. machine &ndash; the  ULTIMATE [typing] battle&hellip;. with bathroom and snack breaks!&nbsp; Just to make it even  more INSANE I documented my steps and created a graphical timeline of the  session in a PRETTY timeline.&nbsp;</p><p class='img-holder'><img src='http://farm3.static.flickr.com/2244/5720966217_edd48fc966_o.png' width='500'></p><p>Ammmm don&rsquo;t mean to be rude but your jaw&hellip;. we&rsquo;ll it&rsquo;s on the floor.&nbsp; Can you  pick it up please?&nbsp; 17:21 to 20:38 minus about an hour and a bit for bathroom,  snack and chat breaks &ndash; zero to datafied in less than 3 hours!&nbsp; Few points to  note,</p><ul><li>This experiment focused on the data model, EF CTP5 and the database. </li><li>There is a working UI (MVC3) it&rsquo;s just not exactly pretty </li><li>I had no EF &ldquo;Code First&rdquo; experience before hand </li><li>I could be doing a few things incorrectly </li><li>It&rsquo;ll probably take me longer to write this post than it did the app. </li></ul><p>So lets look at what I produced.&nbsp; The source is <a href="https://github.com/kouphax/ideas/">available on Github</a><em> for  your&nbsp;fiddling pleasure.</p><p>I am not going to dive into the whole MVC part of it as the source is  available but I may touch on some of the interface points such as controllers  and binders.</p><h2>The Domain Models</h2><p>Lets take a high level look at our domain models.</p><p class='img-holder'><img src='http://farm4.static.flickr.com/3554/5721525430_5e527060d2_o.png' width='650'></p><h3>DomainEntity</h3><p>The abstract domain entity is used to prevent me having to repeat common  auditing and database related stuff across all my entities.&nbsp; It is not mandatory  or derived from anything related to Entity Framework&nbsp;&ndash; all these classes are  simple POCO&rsquo;s.&nbsp; DomainEntity sets up the entities primary key using the Key  attribute and also gold 2 audit related properties CreatedBy and  CreatedDate.</p><p><script src="https://gist.github.com/822204.js"></script></p><h3>Idea</h3><p>Idea is our principle class in our domain.&nbsp; As you can see there are various  associations set up between the other classes.&nbsp; 2 1-</em> mappings between Comment  and Vote and a <em>-</em> mapping between itself and tag (a tag can exist for any  number of ideas and an idea can have many tags).&nbsp; It also holds a number of  methods related to business logic&nbsp;&ndash; specifically calculating Votes, number of  Comments etc.</p><p><script src="https://gist.github.com/822219.js"></script></p><h3>Tag</h3><p>Tag is pretty simple.&nbsp; The only interesting thing about it is the use of  NormalisedName&nbsp;&ndash; essentially the name field lowercased and whitespace removed.&nbsp;  This is used when attempting to fetch potentially existing tags from the  database.</p><p><script src="https://gist.github.com/822220.js"></script></p><h3>Vote</h3><p>Rather than just store a calculated value against an idea the Vote object  represents a rich representation of a Vote (either up or down, whom by and  when).&nbsp; This allows us to provide extra validation when we need it.&nbsp; For example  people not allowed to vote on their own idea or vote on an idea in any  particular direction more than once.&nbsp; Having this rich association makes these  things much easier and we aren&rsquo;t forced to create custom objects to track this  sort of thing.</p><p><script src="https://gist.github.com/822226.js"></script></p><h3>Comment</h3><p>Nothing special here.&nbsp;</p><p><script src="https://gist.github.com/822228.js"></script></p><h2>The Database Context</h2><p>This is where all the EF magic happens.&nbsp; We use this class to provide an  entry point into our database.&nbsp; It&rsquo;s possible to configure entities here in  terms of mapping and associations as well as providing a means to seed the  database with initial data but I didn&rsquo;t need any of that.&nbsp; No I just defined my  sets and added a method for filtering/sorting ideas based on criteria.&nbsp; Simple  stuff yet again.&nbsp; It just extends the DbContext class from Entity Framework.</p><p><script src="https://gist.github.com/822229.js"></script></p><h2>Tag Model Binder</h2><p>This was an interesting thing I discovered.&nbsp; If you are using a <em>-</em>  relationship and are associating one side with an object that already exists you  are required to fetch this object before using it.&nbsp; For example when adding a  tag to an idea I need to attempt fetch that tag first of it exists.&nbsp; What I  can&rsquo;t do is create a new tag object and assign an existing Id to it&nbsp;&ndash; this will  be thrown away and saved as a new instance.&nbsp; To fix this problem I feel back  onto a Tag Model binder that attempts to fetch or create tags depending on their  normalised name.&nbsp; It won&rsquo;t save new tag&nbsp;&ndash; simply create them (this is why I use  a shared DbContext between the controller and the binder).&nbsp; The binder takes a  CSV styled string, breaks it apart, &ldquo;normalises&rdquo; the string and tries to fetch  tags based on their normalised name.&nbsp; If it finds one it pushes it into the  collection otherwise it creates a new tag object and pushes that in instead.&nbsp;  Probably a better way to do that and I am open to suggestions.&nbsp; But what I don&rsquo;t  want is saving tags that are then going to become orphaned if the other save  didn&rsquo;t go through for some reason.</p><p><script src="https://gist.github.com/822235.js"></script></p><h2>Other Things</h2><p>Not very much else worth mentioning right now as I more or less used the MVC  scaffolding to build the views (with some minor tweaking).&nbsp; Validation on the UI  is pushed from the domain object&nbsp;making things a lot more streamlined.&nbsp; The  controllers are still very light and could be made lighter by pushing stuff into  the IdeaRepository as well but that&rsquo;s for another day.</p><p>So there you go.&nbsp; A very quick and dirty intro into the world of Entity  Framework.&nbsp; There isn&rsquo;t anything complex going on here and I was worried that EF  would mask a lot of stuff that we would need access to but it seems there is  plenty of configuration points to hook into.&nbsp; It has come on leaps and bounds  since I last dipped my toes into EF and hopefully they keep up the same  momentum.&nbsp; There is still a lot of due diligence required before I&rsquo;d recommend  EF over any other&nbsp;data access layer that we are currently using but I am  certainly keen to dig deeper and push it to it&rsquo;s limits.</p><p>Once again the source for the solution is <a href="https://github.com/kouphax/ideas/">available on Github</a><em>.&nbsp; Phew&hellip;..&nbsp;</p><p><em></em> Expect bugs.</em></p></p>
]]></content>
  </entry>
  
</feed>
