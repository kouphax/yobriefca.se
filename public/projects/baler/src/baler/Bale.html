<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Bale.cs</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="Bale.html">Bale.cs</a>
          <a class="source" href="Baler.html">Baler.cs</a>
          <a class="source" href="BalerConfiguration.html">BalerConfiguration.cs</a>
          <a class="source" href="FileWriter.html">FileWriter.cs</a>
          <a class="source" href="IBale.html">IBale.cs</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>Bale.cs</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="err">ï»¿</span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CodeSlice.Web.Baler</span>
<span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>A bale represents a single definition of a collection of files that
should be baled together.  A bale is responsible for processing its
items and outputting the bale file and associated HTML tag.  Currently
supports JavaScript and CSS.  No intention for this to change :&ndash;)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">public</span> <span class="k">class</span> <span class="nc">Bale</span> <span class="p">:</span> <span class="n">IBale</span>
    <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-Private_variable_declarations'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Private_variable_declarations">&#182;</a>
        </div>
        <h3>Private variable declarations</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Declare the templates used to output the html tags at the end</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">SCRIPT_TAG_TPL</span> <span class="p">=</span> <span class="s">@&quot;&lt;script type=&#39;text/javascript&#39; src=&#39;{0}&#39; {1}&gt;&lt;/script&gt;&quot;</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">STYLE_TAG_TPL</span> <span class="p">=</span> <span class="s">@&quot;&lt;link href=&#39;{0}&#39; rel=&#39;stylesheet&#39; type=&#39;text/css&#39; {1}/&gt;&quot;</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Hold the references to the bale source items</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">_items</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Before and After lists are sorted.  This allows for us to control
the ordering of the actions.  For example Minification should almost
always be performed at the end (e.g when translating from
coffeescript).  Default ordering will always be 0.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="n">SortedList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">_before</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">SortedList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">_after</span><span class="p">;</span> </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Holds all the custom attributes to be appended to the output tag</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_attrs</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Hold flag and result to ensure that a bale is only generated once
Currently this presents an issue.  If we generate a JS bale first
then use the same items to generate a CSS bale this will return
the old result.  If this happens you&rsquo;ve done it wrong in the first
place.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="kt">bool</span> <span class="n">_isGenerated</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_generatedTag</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Contructors'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Contructors">&#182;</a>
        </div>
        <h3>Contructors</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>A bale can only be built by Baler and by passing the list of
parameters that represent the bale items.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">internal</span> <span class="nf">Bale</span><span class="p">(</span><span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">items</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_items</span> <span class="p">=</span> <span class="n">items</span><span class="p">;</span>
            <span class="n">_before</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SortedList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;();</span>
            <span class="n">_after</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SortedList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;();</span>
            <span class="n">_attrs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Calculates a <code>key</code> for the current bale by joining all the
required paths of items and creating a hash.  This means we
can uniquely identify a set of items as a bale e.g. for caching</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">Key</span> <span class="p">=</span> <span class="n">Bale</span><span class="p">.</span><span class="n">Hash</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Public_Methods'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Public_Methods">&#182;</a>
        </div>
        <h3>Public Methods</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p><code>AsJs()</code> is a convenience method for generating the bale output
file and returning the script tag pointing to that file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">public</span> <span class="kt">string</span> <span class="nf">AsJs</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">GenerateBale</span><span class="p">(</span><span class="s">&quot;js&quot;</span><span class="p">,</span> <span class="n">SCRIPT_TAG_TPL</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p><code>AsCss()</code> is a convenience method for generating the bale output
file and returning the css link tag pointing to that file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">public</span> <span class="kt">string</span> <span class="nf">AsCss</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">GenerateBale</span><span class="p">(</span><span class="s">&quot;css&quot;</span><span class="p">,</span> <span class="n">STYLE_TAG_TPL</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Adds a function to execute on each item of the bale prior to being
merged.  It gets the path and the contents and returns the
transformed content</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">public</span> <span class="n">IBale</span> <span class="nf">Before</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">processor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_before</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">processor</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Adds a function to execute on the concatenated bale content.<br/>
It gets the contents and returns the transformed content</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">public</span> <span class="n">IBale</span> <span class="nf">After</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">processor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_after</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">processor</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Adds a custom attribute to the output tag for this bale e.g.</p>

<pre><code>bale.Attr("media", "screen").AsCss();
</code></pre>

<p>should produce a link tag like so</p>

<p>   <link rel="stylesheet" type="text/css" href="..." media="screen" /></p>

<p>Supports attributes with values as well as attributes with no values
such as <code>async</code> or <code>defer</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">public</span> <span class="n">IBale</span> <span class="nf">Attr</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="k">value</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="k">value</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">_attrs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">_attrs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}=&#39;{1}&#39;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">value</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Public_Properties'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Public_Properties">&#182;</a>
        </div>
        <h3>Public Properties</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Holds the key for this bale that can be used to uniquely
identify this bale based in it&rsquo;s initial contents</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">public</span> <span class="kt">string</span> <span class="n">Key</span>
        <span class="p">{</span>
            <span class="k">get</span><span class="p">;</span>
            <span class="k">private</span> <span class="k">set</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Static_Methods'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Static_Methods">&#182;</a>
        </div>
        <h3>Static Methods</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>        </pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Concatenates</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Hash</span><span class="p">(</span><span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">items</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">items</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">hashBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MD5CryptoServiceProvider</span><span class="p">().</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

            <span class="n">StringBuilder</span> <span class="n">output</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="n">hashBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">hashBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">output</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">hashBytes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ToString</span><span class="p">(</span><span class="s">&quot;X2&quot;</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">output</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Private_Methods'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Private_Methods">&#182;</a>
        </div>
        <h3>Private Methods</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p><code>GenerateBale</code> is the primary method of a bale.  It is
responbile for calculating the output file name and directory,
concatenating and processing the input file and piping them out to
the output directory.  A bale extension <code>js</code> or <code>css</code> need
specififed for completeness and the tag template will be sued to
generate this html tag</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="kt">string</span> <span class="nf">GenerateBale</span><span class="p">(</span><span class="kt">string</span> <span class="n">extension</span><span class="p">,</span> <span class="kt">string</span> <span class="n">template</span><span class="p">)</span>
        <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>check if file has been previously generated and don&rsquo;t generate
again if this is the case</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="k">if</span> <span class="p">(!</span><span class="n">_isGenerated</span><span class="p">)</span>
            <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Copy all files into a single output string and process</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="kt">string</span> <span class="n">content</span> <span class="p">=</span> <span class="n">ConcatenateAllFiles</span><span class="p">();</span>
                <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">content</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Build output file based on content hash and REAL path to
output directory</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="kt">string</span> <span class="n">outputFilename</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}.{1}&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">extension</span><span class="p">);</span>
                <span class="kt">string</span> <span class="n">outputFile</span> <span class="p">=</span> <span class="n">GetOutputFileWithPath</span><span class="p">(</span><span class="n">outputFilename</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>Ensure file doesn&rsquo;t exist before processing it.  This means
newly added processors will not get processed.  There needs
to be a cleaner way to do this.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="k">if</span> <span class="p">(!</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">outputFile</span><span class="p">))</span>
                <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Write contents to file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                    <span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="n">outputFile</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
                <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Calculate relative values for the path so we can output the tag</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="kt">string</span> <span class="n">relativeOutputFile</span> <span class="p">=</span> <span class="n">GetRelativeOutputPath</span><span class="p">(</span><span class="n">outputFilename</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>Create the script tag from the path and the supplied template
and a join of all custom attributes</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="kt">string</span> <span class="n">attrs</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">_attrs</span><span class="p">);</span>
                <span class="kt">string</span> <span class="n">tag</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">relativeOutputFile</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Cache generated tag and mark bale as generated to prevent
future unnecessary processing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="n">_generatedTag</span> <span class="p">=</span> <span class="n">tag</span><span class="p">;</span>
                <span class="n">_isGenerated</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">_generatedTag</span><span class="p">;</span>
        <span class="p">}</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p><code>GetOutputFileWithPath()</code> takes a filename of an output and resolves
the full physical path using the Baler classes configuration for
the <code>OutputPath</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="kt">string</span> <span class="nf">GetOutputFileWithPath</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">outputPath</span> <span class="p">=</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="n">Baler</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">OutputPath</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">outputFile</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">outputFile</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>Similar to <code>GetOutputFileWithPath</code> except rather than output the
physical path to a file it determines the path relative to the root
of the web application</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="kt">string</span> <span class="nf">GetRelativeOutputPath</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">outputRelativePath</span> <span class="p">=</span> <span class="n">Baler</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">OutputPath</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;~/&quot;</span><span class="p">,</span> <span class="n">HttpRuntime</span><span class="p">.</span><span class="n">AppDomainAppVirtualPath</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">relativeOutputFile</span> <span class="p">=</span> <span class="n">outputRelativePath</span> <span class="p">+</span> <span class="s">&quot;/&quot;</span> <span class="p">+</span> <span class="n">filename</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">relativeOutputFile</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Iterates over the current bales items and processes and
concatenates them into a StringBuffer and returns the resultant
string</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">private</span> <span class="kt">string</span> <span class="nf">ConcatenateAllFiles</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">StringBuilder</span> <span class="n">mergedItems</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>Loop over each script reference in the bale collection</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">script</span> <span class="k">in</span> <span class="n">_items</span><span class="p">)</span>
            <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>Derive physical path to the current script source</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="kt">string</span> <span class="n">scriptFile</span> <span class="p">=</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="n">script</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>Read the contents of the input file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="kt">string</span> <span class="n">contents</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="n">scriptFile</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Perform some pre-processing of items if a before function
has been specified</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="k">foreach</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">string</span><span class="p">,</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">before</span> <span class="k">in</span> <span class="n">_before</span><span class="p">.</span><span class="n">Values</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">contents</span> <span class="p">=</span> <span class="n">before</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">contents</span><span class="p">);</span>
                <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>append contents of this item to the ouput file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="n">mergedItems</span><span class="p">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="n">contents</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">string</span> <span class="n">outputContent</span> <span class="p">=</span> <span class="n">mergedItems</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>Perform some post-processing of bale if an after function has
been specified</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="k">foreach</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">after</span> <span class="k">in</span> <span class="n">_after</span><span class="p">.</span><span class="n">Values</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">outputContent</span> <span class="p">=</span> <span class="n">after</span><span class="p">(</span><span class="n">outputContent</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">outputContent</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
