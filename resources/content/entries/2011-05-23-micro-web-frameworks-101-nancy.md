---
date: 2011-05-22T23:00:00Z
title: 'Micro Web Frameworks in .NET 101: Nancy'
published: true
categories: [.NET]
type: article
external: false
---
<p><a href="htttp://nancyfx.org">Nancy</a> is a different beast to <a href="http://jessicafx.org">Jessica</a> while on the surface it may appear like a micro web framework, once you scratch the surface it becomes debatable because there is just some much more than a nice <span class="caps">DSL</span> for creating lightweight web apps.  In fact this was <a href="http://tombell.org.uk/blog/2011/04/10/why-did-i-create-jessica/">one of the reasons</a> Jessica was created,</p><blockquote><p>Nancy has taken an approach to making many parts of the framework replaceable; if you don?t like the functionality of X you can create your own, and have Nancy use that instead. While this is a respectable goal for a web framework, the focus for Jessica has been to stay as simple and as close to Sinatra as possible. <em>Tom Bell.  Why Did I Create Jessica?</em></p></blockquote><p>Anyway we will touch on these aspects a bit later.  Lets get cracking.</p><h2>Getting Started - Hello World</h2><p>Getting <a href="htttp://nancyfx.org">Nancy</a> up and running is simple enough.  Starting with an empty <span class="caps">ASP</span>.<span class="caps">NET</span> web project<sup id="fnr1" class="footnote"><a href="#fn1">1</a></sup> we can use <a href="http://nuget.org/">NuGet</a> to install Nancy</p><p class="minimal-gist"></p><div class="highlight"><pre><code><span class="n">Install</span><span class="p">-</span><span class="n">Package</span> <span class="n">Nancy</span>
</code></pre></div>
<p>Also because we are hosting this in an <span class="caps">ASP</span>.<span class="caps">NET</span> environment (more on this later) we need to install the appropriate hosting package</p><p class="minimal-gist"><div class="highlight"><pre><code><span class="n">Install-Package</span> <span class="n">Nancy</span><span class="p">.</span><span class="n">Hosting</span><span class="p">.</span><span class="n">Aspnet</span>
</code></pre></div>
</p><p>Next step requires us to add some stuff to the <code>web.config</code>.  If you've been smart and installed the hosting package from NuGet this steps is done for you but ultimately your minimal <code>web.config</code> should look like this.</p><div class="highlight"><pre><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;system.web&gt;</span>
    <span class="nt">&lt;compilation</span> <span class="na">debug=</span><span class="s">"true"</span> <span class="na">targetFramework=</span><span class="s">"4.0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;httpHandlers&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">verb=</span><span class="s">"*"</span> <span class="na">type=</span><span class="s">"Nancy.Hosting.Aspnet.NancyHttpRequestHandler"</span> <span class="na">path=</span><span class="s">"*"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/httpHandlers&gt;</span>
  <span class="nt">&lt;/system.web&gt;</span>
  <span class="nt">&lt;system.webServer&gt;</span>
    <span class="nt">&lt;validation</span> <span class="na">validateIntegratedModeConfiguration=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;handlers&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"Nancy"</span> <span class="na">verb=</span><span class="s">"*"</span> <span class="na">type=</span><span class="s">"Nancy.Hosting.Aspnet.NancyHttpRequestHandler"</span> <span class="na">path=</span><span class="s">"*"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/handlers&gt;</span>
  <span class="nt">&lt;/system.webServer&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div>
<p>The final step is to create the hello world module that will handle your route.  Again, like Jessica, it doesn't matter where the module classes are placed but for neatness I just like to stick them in a <code>Modules</code> folder.  Our module will look very similar to the one we defined for Jessica.</p><div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HelloWorldModule</span> <span class="p">:</span> <span class="n">NancyModule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">HelloWorldModule</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Get</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="s">"Hello World"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>And we're done.  Fire the app up and behold the "Hello World"-yness of it all.</p><h2>Other Micro Framework Related Stuff</h2><p><a href="http://nancyfx.org">Nancy</a> has some features that aren't technically related to the micro framework aspect  - specifically hosting but I'll touch on that later.  <a href="http://nancyfx.org">Nancy</a> also has a lot of nice features that are related to the micro framework aspects so lets take a bit of a whirlwind tour around the main areas first.</p><h3>Routes</h3><p>Routes in <a href="http://nancyfx.org">Nancy</a> are pretty powerful.  Obviously you get the declare static routes (as demonstrated above) but dynamic routes (routes with variables for example) are also supported in a few of ways.  First of all you have named segments.  These can be expressed in 2 ways</p><ol>	<li>Sinatra style variables <code>/user/:id</code>, or,</li>	<li>C#-esque <code>String.format</code> style <code>/user/{id}</code></li></ol><p>Declaring a route like this will cause the variable section to be pushed into a named variable within the dynamic object passedin into the route action. <code>/user/jameshu</code> matches <code>/user/:id</code> and the dynamic object passed into the action will have <code>x.id == "jameshu"</code></p><p>The other means of dynamic route matching is the use of regular expressions and named capture groups (or backreferences as they are sometimes known).  Using regular expressions as route parameters allows us to offer more fine grained route matching.  Take the following route as an example,</p><p class="minimal-gist"></p><div class="highlight"><pre><code><span class="n">Get</span><span class="p">[</span><span class="s">@"/users/(?&lt;id&gt;[\d]+)"</span><span class="p">]</span> <span class="p">=</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">GetUser</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
</code></pre></div>
<p>This route will <span class="caps">ONLY</span> match routes whose variable section matches the expression, in this case a numeric value.  So not only have we specified a route variable but we are also limiting access to that action to "valid" values.  This means we could also offer another route that accepts only alphabetical characters.  Powerful enough.</p><h3>Route Conditions</h3><p>Taking routes another step further <a href="http://nancyfx.org">Nancy</a> also offers optional conditions that can be used to determine if a route should be executed for a given request.  Lets use this heavily contrived example to demonstrate this feature,</p><p class="minimal-gist"></p><div class="highlight"><pre><code><span class="n">Get</span><span class="p">[</span><span class="s">"/user"</span><span class="p">,</span> <span class="n">ctx</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Query</span><span class="p">[</span><span class="s">"password"</span><span class="p">]</span> <span class="p">==</span> <span class="s">"secrets"</span><span class="p">]</span> <span class="p">=</span> <span class="n">r</span> <span class="p">=&gt;</span>  <span class="s">"Hello World"</span><span class="p">;</span>
</code></pre></div>
<p>So this route will match any route starting with <code>/user</code> however the condition (the second argument of the definition) will ensure that the route action will only get executed if the query string is populated with an argument called password with a value of secrets i.e <code>http://myserver/user?password=secrets</code> will match successfully.</p><h3>Views</h3><p><a href="http://nancyfx.org">Nancy</a> supports a decent range of view engines<sup id="fnr2" class="footnote"><a href="#fn2">2</a></sup></p><ul>	<li>Razor</li>	<li>Spark</li>	<li>NDjango and, obviously,</li>	<li>Static files</li></ul><p>Serving up dynamic vies is fairly simple</p><div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HelloWorldModule</span> <span class="p">:</span> <span class="n">NancyModule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">HelloWorldModule</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Get</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">View</span><span class="p">[</span><span class="s">"index.cshtml"</span><span class="p">,</span> <span class="s">"Hello World"</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>We basically use the View object to specify the view and optionally pass in a view model as well.  By default Nancy will look in the <code>~/Views</code> folder for the views but you can also specify a full path if needs be.  The view is then matched against the available view engines and rendered as you would expect.  This is the Razor view specified above.</p><div class="highlight"><pre><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>Hello World<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>@Model<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<h3>Responses</h3><p>Nancy is also capable of returning static content as different responses (similar to how Jessica does it).  Each route action is expected to return a Nancy Response object. The object itself has a number of convenience methods for serving static files and <acronym title="JavaScript Object Notation"><span class="caps">JSON</span></acronym> such as <code>Response.AsJs</code>, <code>Response.AsJson</code>, <code>Response.AsXml</code>, , <code>Response.AsRedirect</code> etc.</p><h2>Hosting</h2><p>This is were things move away from "micro framework" world a bit.  Nancy itself abstracts out the hosting environment making the entire framework portable allowing you to host in any number of places including (but not limited to),</p><ul>	<li>Self hosted (e.g. embedded within an executable)</li>	<li><span class="caps">ASP</span>.<span class="caps">NET</span>/<span class="caps">IIS</span> (as demonstrated above)</li>	<li><span class="caps">WCF</span> (yep thats right), and,</li>	<li>Some partial <a href="http://bvanderveen.com/a/dotnet-http-abstractions"><span class="caps">OWIN</span></a> support</li></ul><p>This, to me at least, is very interesting.  Being able to build an executable that accepts <span class="caps">HTTP</span> requests could be pretty powerful in the right hands and the <span class="caps">WCF</span> stuff sounds very interesting (is this similar to what the new <span class="caps">WCF</span> Web <span class="caps">API</span> is attempting to offer?).  I need to play some more in this area.  I'll report back when I am done.</p><h2>Summing Up</h2><p>So that was a quick round up of the key features of Nancy and I think it's another one worth looking at.  So hopefully you can also see how it differs from Jessica.  From a code perspective they seem quite similar (though Nancy has possibly a few more features) but the whole hosting abstraction layer is very interesting.  I have had people ask me if this introduced any new (or even old) security concerns and to be honest I don't know but it might certainly be worth looking out for.</p><p>As always I may need corrections so please fire away.  Hopefully I can cover off these points with a few more screencasts over the next week.  Stay tuned.</p><p id="fn1" class="footnote"><a href="#fnr1"><sup>1</sup></a> In my <a href="http://jessicafx.org">Jessica</a> I laid out steps to strip the normal <span class="caps">ASP</span>.<span class="caps">NET</span> Web Project template out of all the unnecessary bits.  Lord knows why I didn't just create an empty web project &lt;facepalm/&gt;</p><p id="fn2" class="footnote"><a href="#fnr2"><sup>2</sup></a> Apparently it also has a built in view engine called the Super Simple View Engine but as of yet I can't seem to get it to work.</p>