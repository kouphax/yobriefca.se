---
date: 2010-10-18T23:00:00Z
title: '< HEAD >ache: Including JavaScript in ASP.NET Master Pages'
published: true
categories: [.NET, JavaScript]
type: article
external: false
---
<h2>Problem</h2><p>Include a Javascript file in the head of of an ASP.NET WebForms Master Page whose src attribute should contain an absolute (from Application Root) path e.g.http://localhost:8080/js/jquery-1.3.2.js (single application server) or <a href="http://localhost:8080/MyProject/js/jquery-1.3.2.js">http://localhost:8080/MyProject/js/jquery-1.3.2.js</a> (multi application server).  Sounds simple enough but it's surprisingly difficult.</p><h3>Attempt 1: Use a fixed path. (Partial Success)</h3><p></p><div class="highlight"><pre><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">?/js/jquery-1.3.2.js?</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/NIApp/js/jquery-1.3.2.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div>
<p>While this "works" it isn't exactly the most resilient to server changes - what if we move to/from a single/multi application server?  We need to re-write all our URL's</p><h3>Attempt 2: Use Application Root Reference (~) (Fail)</h3><p></p><div class="highlight"><pre><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">?~/js/jquery-1.3.2.js?</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div>
<p>This just plain doesn't work because script tags do not get parsed by ASP page renderer so the URL doesn't get converted and what you see here is what you end up with on the page which obviously isn't correct.</p><h3>Attempt 3: Use Server Code (&lt;%= %&gt;) (Partial Success/Fail)</h3><p></p><div class="highlight"><pre><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">?&lt;%=Page.ResolveUrl(?~/js/jquery-1.3.2.js?)%</span><span class="nt">&gt;</span><span class="o">?</span> <span class="nx">type</span><span class="o">=?</span><span class="nx">text</span><span class="o">/</span><span class="nx">javascript</span><span class="o">?&gt;</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div>
<p>Again this is going to fail in certain situations (but not all).  This will fail when your head tag has a runat="server" attribute present.  In some cases you can simply remove the attribute but if you are using the "out-of-the-box" CSS Themes/Skins you NEED this.</p><h3>Attempt 4: Use a Second &lt;HEAD&gt; Element (Partial Success)</h3><p></p><div class="highlight"><pre><code><span class="nt">&lt;head&gt;</span> 
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">?&lt;%=Page.ResolveUrl(?~/js/jquery-1.3.2.js?)%</span><span class="nt">&gt;</span><span class="o">?</span> <span class="nx">type</span><span class="o">=?</span><span class="nx">text</span><span class="o">/</span><span class="nx">javascript</span><span class="o">?&gt;</span><span class="nt">&lt;/script&gt;</span> 
<span class="nt">&lt;/head&gt;</span> 
<span class="nt">&lt;head</span> <span class="na">runat=</span><span class="s">?server?</span><span class="nt">&gt;</span> ? <span class="nt">&lt;/head&gt;</span>
</code></pre></div>
<p>This will work as you would expect - the only problem is that it isn't valid Markup and will fail if you throw it through W3C Validators.</p><h3>Attempt 5: Add script tags "Outside" Head Element (Partial Success)</h3><p></p><div class="highlight"><pre><code><span class="nt">&lt;head</span> <span class="na">runat=</span><span class="s">?server?</span><span class="nt">&gt;</span> ? <span class="nt">&lt;/head&gt;</span> 
<span class="nt">&lt;body&gt;</span> 
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">?&lt;%=Page.ResolveUrl(?~/js/jquery-1.3.2.js?)%</span><span class="nt">&gt;</span><span class="o">?</span> <span class="nx">type</span><span class="o">=?</span><span class="nx">text</span><span class="o">/</span><span class="nx">javascript</span><span class="o">?&gt;</span><span class="nt">&lt;/script&gt;</span> 
<span class="nt">&lt;/body&gt;</span>
</code></pre></div>
<p>Again this will work the only problem is you can never guarantee another developer won't stick code (which is dependant on your global script) BEFORE your inclusion of said script which is a bit of a &lt;head&gt;ache (i.e. in the &lt;head&gt; element - get it?).</p><h3>Attempt 6: Insert Script Tags via MasterPage Page_Load Event (Success)</h3><p></p><div class="highlight"><pre><code><span class="k">protected</span> <span class="k">void</span> <span class="nf">Page_Load</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HtmlGenericControl</span> <span class="n">script</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HtmlGenericControl</span><span class="p">(</span><span class="err">'</span><span class="n">script</span><span class="err">'</span><span class="p">);</span>
    <span class="n">script</span><span class="p">.</span><span class="n">Attributes</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="err">'</span><span class="n">type</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">text</span><span class="p">/</span><span class="n">javascript</span><span class="err">'</span><span class="p">);</span>
    <span class="n">script</span><span class="p">.</span><span class="n">Attributes</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="err">'</span><span class="n">src</span><span class="err">'</span><span class="p">,</span> <span class="n">ResolveUrl</span><span class="p">(</span><span class="err">'</span><span class="p">~/</span><span class="n">js</span><span class="p">/</span><span class="n">jquery</span><span class="p">-</span><span class="m">1.3</span><span class="p">.</span><span class="m">2.</span><span class="n">js</span><span class="err">'</span><span class="p">));</span>
    <span class="n">Page</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">Controls</span><span class="p">.</span><span class="n">AddAt</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">script</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I suppose this is the first real successful attempt.  It does what it says by dynamically creating new Script tag element and inserting them to the top of &lt;head&gt;.  I inserted everything at the top of the head so no matter where people put their scripts it's going to have all global resources available.  The only problem with this is that EVERY Page_Load event is going to dynamically inject new Elements into the head and it's not exactly a very clean separation of mark-up and code.</p><h3>Attempt 7/Solution 1: Use Data Binding to Evaluate src Attribute (AKA The Holmes Technique)</h3><p>ASPX</p><p></p><div class="highlight"><pre><code><span class="nt">&lt;head</span> <span class="na">runat=</span><span class="s">"server"</span><span class="nt">&gt;</span>    
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">?&lt;%#</span> <span class="na">ResolveUrl</span><span class="err">("~/</span><span class="na">js</span><span class="err">/</span><span class="na">jquery-1</span><span class="err">.</span><span class="na">3</span><span class="err">.</span><span class="na">2</span><span class="err">.</span><span class="na">js</span><span class="err">")%</span><span class="nt">&gt;</span><span class="o">?&gt;</span>   <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;asp:ContentPlaceHolder</span> <span class="na">ID=</span><span class="s">"head"</span> <span class="na">runat=</span><span class="s">"server"</span><span class="nt">&gt;&lt;/asp:ContentPlaceHolder&gt;</span>
<span class="nt">&lt;/head&gt;</span>
</code></pre></div>
<p>Jonny Holmes <a href="http://leedumond.com/blog/the-controls-collection-cannot-be-modified-because-the-control-contains-code-blocks/">uncovered</a> a more elegant solution to this issue and it is described above.  It gets around the issue of not being able to use &lt;%= %&gt; tags by using a Data Binding Expression.  And all you have to do is perform a DataBind() during the Page_Load event and you're sorted like <a href="http://www.youtube.com/watch?v=e0Mzr_A-Q0I">Ebenezer</a>.</p><p><div class="highlight"><pre><code><span class="k">protected</span> <span class="k">void</span> <span class="nf">Page_Load</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//Called for the javascript references in the header of the master page</span>
    <span class="n">Page</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">DataBind</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</p><p>Anyone got any other methods to do this?</p>